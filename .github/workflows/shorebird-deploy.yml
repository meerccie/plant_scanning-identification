name: Shorebird Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: üöÄ Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # 1Ô∏è‚É£ Checkout repo with credentials for git push
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      # 2Ô∏è‚É£ Setup Flutter
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'

      # 3Ô∏è‚É£ Get dependencies & run tests
      - run: flutter pub get
      - run: flutter test --concurrency=4

      # 4Ô∏è‚É£ Bump build number automatically
      - name: üî¢ Bump build number
        shell: bash
        run: |
          echo "üìÑ Current version in pubspec.yaml:"
          grep '^version:' pubspec.yaml

          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          VERSION_NAME=$(echo "$CURRENT_VERSION" | cut -d'+' -f1)
          VERSION_CODE=$(echo "$CURRENT_VERSION" | cut -d'+' -f2)
          if [ -z "$VERSION_CODE" ]; then VERSION_CODE=1; fi
          NEW_VERSION_CODE=$((VERSION_CODE + 1))

          echo "üîß Bumping version: ${VERSION_NAME}+${NEW_VERSION_CODE}"
          sed -i.bak -E "s/^version:[[:space:]]*[0-9]+\.[0-9]+\.[0-9]+\+[0-9]+/version: ${VERSION_NAME}+${NEW_VERSION_CODE}/" pubspec.yaml
          rm -f pubspec.yaml.bak

          echo "‚úÖ New version line:"
          grep '^version:' pubspec.yaml

      # 5Ô∏è‚É£ Commit bumped version
      - name: Commit bumped version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml
          git commit -m "chore: bump build number for Shorebird release" || echo "No changes to commit"
          git push

      # 6Ô∏è‚É£ Deploy with Shorebird
      - name: üì¶ Deploy with Shorebird
        run: |
          curl -fsSL https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh | bash
          SHOREBIRD_CMD="$HOME/.config/shorebird/bin/shorebird"

          # Verify installation
          $SHOREBIRD_CMD --version

          # Login
          echo "$SHOREBIRD_TOKEN" | $SHOREBIRD_CMD login

          # Release & patch
          echo "üöÄ Releasing version:"
          cat pubspec.yaml | grep version

          $SHOREBIRD_CMD release android --no-confirm
          $SHOREBIRD_CMD patch android --no-confirm

          echo "‚úÖ Shorebird deployment successful!"
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
