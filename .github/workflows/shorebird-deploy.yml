name: Shorebird Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: üöÄ Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Flutter
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'

      # 3Ô∏è‚É£ Get dependencies & run tests
      - run: flutter pub get
      - run: flutter test --concurrency=4

      # 4Ô∏è‚É£ Install jq (for JSON parsing)
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 5Ô∏è‚É£ Install Shorebird
      - name: Install Shorebird
        run: |
          curl -fsSL https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh | bash
          SHOREBIRD_CMD="$HOME/.config/shorebird/bin/shorebird"
          $SHOREBIRD_CMD --version

      # 6Ô∏è‚É£ Login to Shorebird
      - name: Shorebird Login
        run: |
          SHOREBIRD_CMD="$HOME/.config/shorebird/bin/shorebird"
          echo "$SHOREBIRD_TOKEN" | $SHOREBIRD_CMD login
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

      # 7Ô∏è‚É£ Auto bump build number above last release
      - name: üî¢ Auto bump build number
        shell: bash
        run: |
          SHOREBIRD_CMD="$HOME/.config/shorebird/bin/shorebird"
          APP_ID="3adc5582-3466-40f0-a1d8-fa5d98695859"

          # Get Shorebird Android releases safely
          RELEASES_JSON=$($SHOREBIRD_CMD releases android --app $APP_ID --json 2>/dev/null)

          if [[ -z "$RELEASES_JSON" || "$RELEASES_JSON" == "[]" ]]; then
            LAST_RELEASE=1
            echo "üìù No previous releases found, starting with build 1"
          else
            LAST_RELEASE=$(echo "$RELEASES_JSON" | jq -r '.[0].version' | awk -F'+' '{print $2}')
            if [[ -z "$LAST_RELEASE" ]]; then
              LAST_RELEASE=1
            fi
            echo "üìù Last Shorebird release build number: $LAST_RELEASE"
          fi

          # Read current pubspec.yaml version
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          VERSION_NAME=$(echo "$CURRENT_VERSION" | cut -d'+' -f1)

          # Increment build number
          NEW_VERSION_CODE=$((LAST_RELEASE + 1))
          echo "üîß Setting new version: ${VERSION_NAME}+${NEW_VERSION_CODE}"

          sed -i.bak -E "s/^version:[[:space:]]*[0-9]+\.[0-9]+\.[0-9]+\+[0-9]+/version: ${VERSION_NAME}+${NEW_VERSION_CODE}/" pubspec.yaml
          rm -f pubspec.yaml.bak

          echo "‚úÖ New version line:"
          grep '^version:' pubspec.yaml

      # 8Ô∏è‚É£ Deploy with Shorebird
      - name: üì¶ Deploy with Shorebird
        shell: bash
        run: |
          SHOREBIRD_CMD="$HOME/.config/shorebird/bin/shorebird"
          echo "üöÄ Releasing version:"
          cat pubspec.yaml | grep version
          $SHOREBIRD_CMD release android --no-confirm
          $SHOREBIRD_CMD patch android --no-confirm
          echo "‚úÖ Shorebird deployment successful!"
        env:
          SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
