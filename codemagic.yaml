# This file must be in the root directory of your project.

workflows:
Â  # WORKFLOW 1: For creating the initial APK and registering it with Shorebird.
Â  android-apk-release:
Â  Â  name: ðŸš€ Build & Register Initial APK
Â  Â  instance_type: linux_standard # FIXED: Changed from linux_x2 to a type available on the basic plan

Â  Â  environment:
Â  Â  Â  flutter: stable
Â  Â  Â  groups:
Â  Â  Â  Â  - shorebird_credentials
Â  Â  Â  Â  - keystore_credentials
Â  Â  Â  Â  - api_keys
Â  Â  Â  Â  - supabase_credentials
Â  Â  Â  android_signing:
Â  Â  Â  Â  - meerc # Replace with the reference name from Codemagic UI

Â  Â  scripts:
Â  Â  Â  - name: ðŸ“¦ Build and Register Shorebird APK
Â  Â  Â  Â  script: |
Â  Â  Â  Â  Â  #!/bin/bash
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # 1. Install Shorebird CLI
Â  Â  Â  Â  Â  curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # 2. Add Shorebird to the PATH
Â  Â  Â  Â  Â  export PATH="$HOME/.shorebird/bin:$PATH"
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # 3. CRITICAL: Authenticate Shorebird using the secret token
Â  Â  Â  Â  Â  # Assumes SHOREBIRD_TOKEN is the variable name in your 'shorebird_credentials' group
Â  Â  Â  Â  Â  export SHOREBIRD_TOKEN="$SHOREBIRD_TOKEN"
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # 4. Define all client-side variables for Dart
Â  Â  Â  Â  Â  DEFINES=(
Â  Â  Â  Â  Â  Â  "PLANTNET_API_KEY=$PLANTNET_API_KEY"
Â  Â  Â  Â  Â  Â  "PLANTNET_PROJECT=$PLANTNET_PROJECT"
Â  Â  Â  Â  Â  Â  "SUPABASE_URL=$SUPABASE_URL"
Â  Â  Â  Â  Â  Â  "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY"
Â  Â  Â  Â  Â  Â  "PERENUAL_API_KEY=$PERENUAL_API_KEY"
Â  Â  Â  Â  Â  Â  "GEMINI_API_KEY=$GEMINI_API_KEY"
Â  Â  Â  Â  Â  Â  "GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY"
Â  Â  Â  Â  Â  Â  "OPENWEATHER_API_KEY=$OPENWEATHER_API_KEY"
Â  Â  Â  Â  Â  Â  # NOTE: SUPABASE_SERVICE_ROLE_KEY is a backend secret and should not be passed to the client app.
Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # 5. Run the release command, passing defines via --dart-define
Â  Â  Â  Â  Â  # The '--' separates Flutter-specific args from shorebird args
Â  Â  Â  Â  Â  shorebird release android --artifact apk -- "${DEFINES[@]/#/--dart-define=}"

Â  Â  artifacts:
Â  Â  Â  - build/app/outputs/apk/release/app-release.apk

Â  # --------------------------------------------------------------------------

Â  # WORKFLOW 2: For pushing over-the-air (OTA) updates for an existing release.
Â  android-patch-update:
Â  Â  name: ðŸ©¹ Push OTA Patch
Â  Â  instance_type: linux_standard # FIXED: Changed from linux_x2 to a type available on the basic plan

Â  Â  environment:
Â  Â  Â  flutter: stable
Â  Â  Â  groups:
Â  Â  Â  Â  - shorebird_credentials

Â  Â  scripts:
Â  Â  Â  - name: ðŸ©¹ Create and Upload Patch
Â  Â  Â  Â  script: |
Â  Â  Â  Â  Â  #!/bin/bash
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # 1. Install Shorebird CLI
Â  Â  Â  Â  Â  curl --proto '=https' --tlsv1.2 https://raw.githubusercontent.com/shorebirdtech/install/main/install.sh -sSf | bash
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # 2. Add Shorebird to the PATH
Â  Â  Â  Â  Â  export PATH="$HOME/.shorebird/bin:$PATH"

Â  Â  Â  Â  Â  # 3. CRITICAL: Authenticate Shorebird using the secret token
Â  Â  Â  Â  Â  export SHOREBIRD_TOKEN="$SHOREBIRD_TOKEN"
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # 4. Run the patch command
Â  Â  Â  Â  Â  shorebird patch android --release-version latest